
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../diagram-examples/">
      
      
      
      <link rel="icon" href="../assets/favicon.jpeg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>API Gateway Setup Documentation - KarreraAI Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-gateway-setup-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="KarreraAI Docs" class="md-header__button md-logo" aria-label="KarreraAI Docs" data-md-component="logo">
      
  <img src="../assets/KarreraLogo.jpeg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            KarreraAI Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Gateway Setup Documentation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="KarreraAI Docs" class="md-nav__button md-logo" aria-label="KarreraAI Docs" data-md-component="logo">
      
  <img src="../assets/KarreraLogo.jpeg" alt="logo">

    </a>
    KarreraAI Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to KarreraAI Docs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Personal-AI-APIs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation for the Personal-AI APIs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../admonitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Admonitions
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../code-examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code examples
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../content-tab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Content tab
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../diagram-examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Diagram Examples
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API Gateway Setup Documentation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API Gateway Setup Documentation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-managed-api-gateways-for-vm-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Overview: Managed API Gateways for VM backends
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Steps:
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Steps:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-check-for-appropriate-permissions-in-gcp-recommended-iam-roles-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Check for appropriate permissions in GCP (Recommended IAM Roles and Best Practices):
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Check for appropriate permissions in GCP (Recommended IAM Roles and Best Practices):">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommended-predefined-iam-roles" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended Predefined IAM Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#important-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Important Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-define-api-specification" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Define API Specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-create-and-deploy-the-api-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create and Deploy the API Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-api-key-management" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: API Key Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-testing-your-api-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Testing Your API Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-monitoring-and-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Monitoring and Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-managed-api-gateways-for-vm-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Overview: Managed API Gateways for VM backends
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Steps:
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Steps:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-check-for-appropriate-permissions-in-gcp-recommended-iam-roles-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Check for appropriate permissions in GCP (Recommended IAM Roles and Best Practices):
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Check for appropriate permissions in GCP (Recommended IAM Roles and Best Practices):">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommended-predefined-iam-roles" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended Predefined IAM Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#important-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Important Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-define-api-specification" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Define API Specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-create-and-deploy-the-api-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create and Deploy the API Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-api-key-management" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: API Key Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-testing-your-api-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Testing Your API Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-monitoring-and-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Monitoring and Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-gateway-setup-documentation">API Gateway Setup Documentation</h1>
<p>This document explains the setup of the API Gateway for the project <strong>Karrera - Personal AI</strong> project using Google Cloud API Gateway. The backend services are hosted on <strong>Google Compute Engine (VM)</strong>, and the API is defined using <strong>OpenAPI 2.0</strong>. It explains how to use Google Cloud's fully managed API Gateway to securely expose an application running on a Compute Engine Virtual Machine (VM). This approach is ideal for centralizing API access, providing API key enforcement, and decoupling clients from your backend VM's network details, all without managing gateway infrastructure yourself.</p>
<h2 id="overview-managed-api-gateways-for-vm-backends">Overview: Managed API Gateways for VM backends</h2>
<p>Google's API Gateway acts as a single entry point for all API calls, sitting in front of your backend services. When your backend is a Compute Engine VM, the API Gateway provides a managed layer that handles:</p>
<ul>
<li><strong>Traffic Management</strong>: Routes incoming requests to your VM application.</li>
<li><strong>Security</strong>: Enforces API keys, providing a crucial layer of access control before requests even reach your VM.</li>
<li><strong>Decoupling</strong>: Hides the VM's internal IP address and specific network configuration from external clients.</li>
<li><strong>Observability</strong>: Integrates seamlessly with Cloud Monitoring and Cloud Logging for request tracing and performance insights.</li>
<li><strong>Scalability</strong>: The gateway itself is a serverless service, automatically scaling to handle traffic.</li>
</ul>
<p>This setup simplifies operations compared to running a custom gateway (self-managed) on a VM, as Google manages the gateway infrastructure, patching, and scaling.</p>
<hr />
<h2 id="architecture">Architecture</h2>
<p>In this architecture, the Google Cloud API Gateway acts as a proxy for your application running on a Compute Engine VM.</p>
<ul>
<li><strong>Client</strong>: Makes requests to the public URL provided by the API Gateway.</li>
<li><strong>GCP API Gateway</strong>: <ul>
<li>Receives external API requests.</li>
<li>Enforces configured security policies (e.g., API key validation).</li>
<li>Routes validated requests to your Compute Engine VM using its internal IP address.</li>
<li>Handles response forwarding back to the client.</li>
</ul>
</li>
<li><strong>Backend</strong>: Flask API running on a Google Cloud VM<ul>
<li>Hosts your API application (e.g., a web server, microservice).</li>
<li>Listens for incoming requests on a specific port, typically on its internal IP address.</li>
<li>Does not require an external IP address for direct client access, as all traffic is routed through the API Gateway.</li>
</ul>
</li>
</ul>
<pre class="mermaid"><code>graph LR
    subgraph External Clients
        A[External Users/Applications]
    end

    subgraph API Gateway Layer
        B[Google Cloud API Gateway]
    end

    subgraph Compute Engine VM/Backend Services
        direction LR
        C1[User Session Init]
        C2[Search From Web ]
        C3[CV Reader]
    end

    A -- HTTPS Requests --&gt; B

    B -- Internal HTTP/S Requests --&gt; C1
    B -- Internal HTTP/S Requests --&gt; C2
    B -- Internal HTTP/S Requests --&gt; C3

    style B fill:#3F704D,stroke:#39a0b9,stroke-width:2px,font-color:#000000
    style C1 fill:#708238,stroke:#a039b9,stroke-width:2px,font-color:#000000
    style C2 fill:#708238,stroke:#a039b9,stroke-width:2px,font-color:#000000
    style C3 fill:#708238,stroke:#a039b9,stroke-width:2px,font-color:#000000
</code></pre>
<hr />
<h2 id="implementation-steps">Implementation Steps:</h2>
<h3 id="step-1-check-for-appropriate-permissions-in-gcp-recommended-iam-roles-and-best-practices">Step 1: Check for appropriate permissions in GCP (Recommended IAM Roles and Best Practices):</h3>
<p>Since we are running a VM on GCP, and working using this cloud, we firstly have to make sure we have the appropriate permissions to create and work on the API Gateway in Google Cloud, including the configuration of API key enforcement.</p>
<p><strong>Principle of Least Privilege:</strong> When assigning permissions, it's a security best practice to follow the Principle of Least Privilege (POLP). This means granting only the minimum permissions necessary for a task, rather than broad roles like "Owner" or "Editor," which provide excessive access and increase security risks.</p>
<h4 id="recommended-predefined-iam-roles">Recommended Predefined IAM Roles</h4>
<p>For a user or service account involved in creating, deploying, and managing an API Gateway with API key enforcement, the following roles are a good starting point:</p>
<ol>
<li>
<p><strong>API Gateway Admin (<code>roles/apigateway.admin</code>)</strong></p>
<ul>
<li><strong>Why it's used:</strong> This role grants comprehensive permissions for managing API Gateway resources directly. It allows the creation, updating, retrieval, and deletion of API definitions, API configurations (derived from your OpenAPI spec), and the API Gateway instances themselves.</li>
<li><strong>How it's used:</strong> Essential for the core operations of setting up and modifying your API Gateway, such as deploying new OpenAPI configurations or updating gateway settings.</li>
</ul>
</li>
<li>
<p><strong>Service Management Administrator (<code>roles/servicemanagement.admin</code>)</strong></p>
<ul>
<li><strong>Why it's used:</strong> API Gateway relies on Google Cloud's Service Management infrastructure. When you deploy an API Gateway configuration, a "managed service" is created (e.g., <code>your-api.apigateway.your-project.cloud.goog</code>). This role provides the necessary permissions to create and manage these underlying services. This is often the critical role when encountering "address not enabled for the project" errors.</li>
<li><strong>How it's used:</strong> Enables the API Gateway to register its service in Service Management, making it discoverable and manageable within your project.</li>
</ul>
</li>
<li>
<p><strong>Service Usage Admin (<code>roles/serviceusage.admin</code>)</strong></p>
<ul>
<li><strong>Why it's used:</strong> This role allows users to enable and disable Google Cloud APIs and services within a project. It's crucial for ensuring that necessary APIs (like the API Gateway API itself) are active for your project.</li>
<li><strong>How it's used:</strong> Used to enable the core <code>API Gateway API</code> (<code>apigateway.googleapis.com</code>) and other Google APIs that your backend services might rely on.</li>
</ul>
</li>
<li>
<p><strong>API Keys Admin (<code>roles/serviceusage.apiKeysAdmin</code>)</strong></p>
<ul>
<li><strong>Why it's used:</strong> This role provides permissions for managing API keys, including creating, listing, updating, and deleting them. It's essential for generating and restricting the API keys that your clients will use to authenticate with your API Gateway.</li>
<li><strong>How it's used:</strong> Necessary for creating the API key in the Google Cloud Console and, crucially, for restricting it to your specific API Gateway service, ensuring it's only valid for your API.</li>
</ul>
</li>
<li>
<p><strong>Compute Network Viewer (<code>roles/compute.networkViewer</code>) or Compute Network User (<code>roles/compute.networkUser</code>)</strong></p>
<ul>
<li><strong>Why it's used:</strong>  While API Gateway itself doesn't need to manage VM instances, the user deploying the gateway might need to view or interact with network resources (like internal IPs, firewall rules) to correctly configure the <code>x-google-backend.address</code> and ensure network connectivity.</li>
<li><strong>How it's used:</strong> To retrieve the VM's internal IP and verify firewall configurations.</li>
</ul>
</li>
</ol>
<h4 id="important-considerations"><strong>Important Considerations</strong></h4>
<ul>
<li>
<p><strong>Service Accounts for Automation:</strong></p>
<ul>
<li>Always use a dedicated <strong>service account</strong> instead of a user account.</li>
<li>Grant this service account <em>only</em> the specific roles listed above. This minimizes the blast radius of any potential security breaches.</li>
</ul>
</li>
<li>
<p><strong>Enabling Necessary APIs:</strong></p>
<ul>
<li>Before deploying your API Gateway, ensure that the core Google Cloud APIs it relies on are enabled in your project.</li>
<li><strong>Key APIs to enable:</strong><ul>
<li><strong>API Gateway API</strong> (<code>apigateway.googleapis.com</code>)</li>
<li>
<p><strong>The specific API Gateway created</strong> -- after its creation: When you deploy an API configuration to API Gateway, Google Cloud automatically creates a unique "managed service" in the background that represents your API. This service needs to be explicitly enabled in your project before the API Gateway can properly serve traffic and enforce API key restrictions. If this service is not enabled, you might encounter <code>PERMISSION_DENIED</code> errors, indicating that the API targeted by the request is not enabled for the project.</p>
<p>Here's how to enable it:</p>
<ol>
<li>
<p><strong>Identify The Managed Service Name:</strong></p>
<ul>
<li>During the API Config creation step (e.g., Step 3.2 in the full deployment guide), you should have noted down the "Managed Service" name. It typically follows this pattern: <code>YOUR_API_ID.apigateway.YOUR_PROJECT_ID.cloud.goog</code>.</li>
<li>If you don't have it, you can find it by navigating to <strong>API Gateway &gt; APIs</strong> in the Google Cloud Console, selecting your API, and looking for the "Managed Service" column or property in the API details.</li>
</ul>
</li>
<li>
<p><strong>Enable the Service via API Library:</strong></p>
<ul>
<li>In the <strong>Google Cloud Console</strong>, go to <strong>APIs &amp; Services &gt; Library</strong>.</li>
<li>In the search bar provided, paste or type the <strong>exact Managed Service name</strong> you identified in the previous step (e.g., <code>my-api-12345.apigateway.my-project.cloud.goog</code>).</li>
<li>The search results should display your API's managed service. Click on it.</li>
<li>On the service's details page, click the <strong>ENABLE</strong> button.</li>
</ul>
</li>
</ol>
<p>Once enabled, allow a few moments for the changes to propagate throughout Google Cloud's infrastructure. After this, your API Gateway should be ready to correctly route requests and enforce its configured security policies.</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>API Key Restrictions (Crucial Security Practice):</strong></p>
<ul>
<li>After creating an API key in Google Cloud, it is <strong>imperative</strong> to restrict it.</li>
<li><strong>How to restrict:</strong><ol>
<li>Go to <strong>APIs &amp; Services &gt; Credentials</strong> in the Google Cloud Console.</li>
<li>Edit your API key.</li>
<li>Under "API restrictions," choose "Restrict key."</li>
<li>Select your specific API Gateway service (e.g., <code>YOUR_API_NAME.apigateway.YOUR_PROJECT_ID.cloud.goog</code>) from the dropdown.</li>
<li>Additionally, you might want to restrict it to other relevant Google APIs like <code>API Gateway API</code> and <code>Service Control API</code>.</li>
</ol>
</li>
<li><strong>Why it's important:</strong> Restricting API keys ensures they can only be used to access the specific services you intend, preventing unauthorized access to other resources in your project if the key is compromised.</li>
</ul>
</li>
</ul>
<h3 id="step-2-define-api-specification">Step 2: Define API Specification</h3>
<ul>
<li><strong>Purpose</strong>:  Create an OpenAPI (Swagger 2.0) specification file (e.g., api-gateway-spec.yaml) that describes your API and tells the API Gateway how to route requests to your VM backend.</li>
<li>
<p><strong>Activities</strong>:</p>
<ol>
<li>Define the basic info:<ul>
<li>Standard: <strong><em>Swagger/OPEN API 2.0</em></strong></li>
<li>Title, Description, and Version of Configuration</li>
</ul>
</li>
<li>Define all endpoints, methods, and expected behaviors</li>
<li>Document request/response formats using OpenAPI 2.0 standards</li>
<li>Specify path parameters, query strings, and body schemas</li>
<li>Map API services to backend services, and define the timeout limit (600s)</li>
<li>Add security scheme definitions (API keys for now)</li>
</ol>
</li>
<li>
<p><strong>Key elements for a VM backend</strong>:</p>
<ul>
<li><strong><em><code>x-google-backend.address</code></em></strong>: This is the most crucial part. It must point to the internal IP address and port of your Compute Engine VM.</li>
<li><strong><em><code>securityDefinitions</code> and <code>security</code></em></strong>: For API Key enforcement.</li>
</ul>
</li>
<li>
<p><strong>Output</strong>: Here's a small version of the OpenAPI spec used:</p>
</li>
</ul>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">api-gateway-spec.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># Basic information</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">swagger</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">info</span><span class="p">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;API</span><span class="nv"> </span><span class="s">Gateway</span><span class="nv"> </span><span class="s">Configuration</span><span class="nv"> </span><span class="s">Test&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Test</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">Gateway&quot;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0.0</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1"># Enforce API Key security</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nt">securityDefinitions</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="nt">api_key</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;apiKey&quot;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;x-api-key&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;header&quot;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="c1"># Require the api_key security scheme (defined above) for all paths and methods unless overridden.</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nt">security</span><span class="p">:</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="c1"># Sinece most of the methods consume and produce json texts, define a basic expected behavior (can be overriden)</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="nt">consumes</span><span class="p">:</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="nt">produces</span><span class="p">:</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="c1"># Define the backend address</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="nt">x-google-backend</span><span class="p">:</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://&lt;YOUR_VM_INTERNAL_IP&gt;:&lt;YOUR_APP_PORT&gt;</span><span class="w"> </span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">  </span><span class="nt">deadline</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600.0</span><span class="w"> </span><span class="c1">## the timeout limit, in seconds</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="c1"># Define each endpoint under paths</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">   </span><span class="c1"># Endpoint name</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">  </span><span class="nt">/user_session_init</span><span class="p">:</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="c1"># Endpoint request type</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="nt">post</span><span class="p">:</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">      </span><span class="c1"># Write the basic information of this microsservice</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">      </span><span class="nt">operationId</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">userSessionInit</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initializes a user session in Redis</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initializes a user session in Redis using the `name` and `user-id` from request headers.</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">      </span><span class="c1"># Write down what parameters the method takes</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">      </span><span class="nt">parameters</span><span class="p">:</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">header</span><span class="w"> </span><span class="c1"># Where the parameter goes in the request</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="w"> </span><span class="c1"># Name of the key</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span><span class="w"> </span><span class="c1"># Type of the parameter</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">          </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># If it is required or not</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">header</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user-id</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">          </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">      </span><span class="c1"># Define Responses (required, but since we have already defined responses in our methods, not really necessary -- we can specify it later)</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">        </span><span class="nt">200</span><span class="p">:</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OK</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>[!IMPORTANT] 
Replace <YOUR_VM_INTERNAL_IP> and <YOUR_APP_PORT> with the Karrera VM's internal IP and the port.</p>
</blockquote>
<h3 id="step-3-create-and-deploy-the-api-gateway">Step 3: Create and Deploy the API Gateway</h3>
<ol>
<li><strong>Enable API Gateway API:</strong><ul>
<li>Go to APIs &amp; Services &gt; Library in the GCP Console.</li>
<li>Search for <strong>"API Gateway API"</strong> and ensure it's enabled.</li>
</ul>
</li>
<li><strong>Create API Config:</strong><ul>
<li>In the GCP Console, navigate to <strong>API Gateway &gt; APIs</strong>.</li>
<li>Click <strong>CREATE API</strong>.</li>
<li>Give your API a display name (e.g., <code>vm-backend-api</code>).</li>
<li>Click <strong>BROWSE</strong> under "API spec" and upload your <code>api-gateway-spec.yaml</code>file.</li>
<li>Click <strong>CONTINUE</strong>.</li>
<li>Take note of the "Managed Service" name (e.g., <code>my-api-12345.apigateway.my-project.cloud.goog</code>). This is important for API key restrictions.</li>
<li>Click <strong>CREATE API CONFIG</strong>.</li>
</ul>
</li>
<li><strong>Create Gateway:</strong><ul>
<li>Once the API Config is created, navigate to <strong>API Gateway &gt; Gateways</strong>.</li>
<li>Click <strong>CREATE GATEWAY</strong>.</li>
<li><strong>Gateway name</strong>: Choose a unique name (e.g., <code>my-vm-gateway</code>).</li>
<li><strong>Region</strong>: Select a region. Ideally, one close to your VM to minimize latency.</li>
<li><strong>API</strong>: Select the API you just created (e.g., vm-backend-api).</li>
<li><strong>API config</strong>: Select the API config you just created.</li>
<li>Click <strong>CREATE GATEWAY</strong>.</li>
<li>Wait for the gateway to deploy. Once complete, you'll see a default URL for your gateway (e.g., <code>https://my-vm-gateway-abc12def.ts.gateway.cloud.goog</code>).</li>
</ul>
</li>
</ol>
<h3 id="step-4-api-key-management">Step 4: API Key Management</h3>
<p>API Keys provide a simple yet effective mechanism for controlling access to your API Gateway. Proper management and restriction of these keys are vital for security.</p>
<ol>
<li>
<p><strong>Create an API Key:</strong></p>
<ul>
<li>Navigate to the <strong>Google Cloud Console</strong>.</li>
<li>Go to <strong>APIs &amp; Services &gt; Credentials</strong>.</li>
<li>Click on <strong>CREATE CREDENTIALS &gt; API Key</strong>.</li>
<li>A new API key string will be automatically generated. <strong>Copy this key immediately</strong> as you will need it for testing and client applications.</li>
</ul>
</li>
<li>
<p><strong>Restrict the API Key (Crucial for Security):</strong>
    Once created, an API key is by default unrestricted, meaning it could potentially be used to access any enabled API in your project. This is a significant security risk. The API key <strong>must</strong> be restricted to only allow access to the specific API Gateway.</p>
<ul>
<li>On the same <strong>Credentials</strong> page, locate the newly created API key.</li>
<li>Click the <strong>EDIT API KEY</strong> icon (pencil) next to it.</li>
<li>Under the <strong>API restrictions</strong> section, select the <strong>Restrict key</strong> radio button.</li>
<li>From the "Select APIs" dropdown menu, select the following APIs:<ul>
<li><strong><code>API Gateway API</code></strong> (<code>apigateway.googleapis.com</code>)</li>
<li><strong>Your specific Managed Service name</strong> (e.g., <code>my-api-12345.apigateway.my-project.cloud.goog</code>). You would have obtained this name during the API Config creation step (typically Step 3.2 in the full deployment guide).</li>
</ul>
</li>
<li>Click <strong>OK</strong> to confirm your selections.</li>
<li>Finally, click <strong>SAVE</strong> at the bottom of the page to apply the restrictions.</li>
</ul>
</li>
</ol>
<h3 id="step-5-testing-your-api-gateway">Step 5: Testing Your API Gateway</h3>
<p>Thorough testing is essential to confirm that your API Gateway is correctly configured, routing traffic, and enforcing API key security.</p>
<ol>
<li>
<p><strong>Test with API Key (Expected Success):</strong>
    This test verifies that your API Gateway accepts valid API keys and successfully routes requests to your backend application.</p>
<ul>
<li>Open an API client like Postman, curl, or any preferred tool.</li>
<li>Construct a request to your API Gateway's public URL. The URL format will be <code>https://&lt;YOUR_GATEWAY_URL&gt;/&lt;YOUR_API_PATH&gt;</code> (e.g., <code>https://my-vm-gateway-abc12def.ts.gateway.cloud.goog/my-app-endpoint</code>).</li>
<li><strong>Include a header:</strong> Add an <code>X-API-Key</code> header with the API key you copied from Step 4.1.
    <div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>X-API-Key: &lt;YOUR_API_KEY&gt;
</span></code></pre></div>
    (Replace <code>&lt;YOUR_API_KEY&gt;</code> with your actual generated key.)</li>
<li>Send the request.</li>
<li><strong>Expected Outcome:</strong> You should receive a successful HTTP <code>200 OK</code> response (or whatever success code your backend application returns) from your VM application, indicating the request was processed correctly.</li>
</ul>
</li>
<li>
<p><strong>Test without API Key (Expected Failure):</strong>
    This test confirms that your API Gateway's API key enforcement is active and blocking unauthorized access.</p>
<ul>
<li>Make the same request to your API Gateway URL as in the previous test.</li>
<li><strong>Crucially, do NOT include</strong> the <code>X-API-Key</code> header in this request.</li>
<li>Send the request.</li>
<li><strong>Expected Outcome:</strong> You should receive an HTTP <code>401 Unauthorized</code> or <code>403 Forbidden</code> response. This indicates that the API Gateway successfully detected the missing API key and blocked the unauthorized request, confirming your security measures are working.</li>
</ul>
</li>
</ol>
<h3 id="step-6-monitoring-and-logging">Step 6: Monitoring and Logging</h3>
<p>Google Cloud API Gateway is deeply integrated with Cloud Logging and Cloud Monitoring, providing out-of-the-box observability for your API traffic and performance.</p>
<ol>
<li>
<p><strong>Cloud Logging (For Request Details and Errors):</strong>
    Cloud Logging captures detailed logs for every request handled by your API Gateway, providing insights into traffic flow, latency, and any issues encountered.</p>
<ul>
<li>In the Google Cloud Console, navigate to <strong>Logging &gt; Logs Explorer</strong>.</li>
<li>In the "Resource" filter, select <code>API Gateway Gateway</code>.</li>
<li>You will see log entries for each request, including:<ul>
<li>HTTP status codes (e.g., 200, 401, 500)</li>
<li>Request latency</li>
<li>Source IP addresses</li>
<li>Details on backend communication</li>
<li>Error messages (if any)</li>
</ul>
</li>
<li>You can use the query builder to filter logs by <code>method</code>, <code>status</code>, <code>request_id</code>, and other parameters to troubleshoot specific issues.</li>
</ul>
</li>
<li>
<p><strong>Cloud Monitoring (For Metrics and Performance):</strong>
    Cloud Monitoring allows you to observe the performance and health of your API Gateway over time through various metrics.</p>
<ul>
<li>In the Google Cloud Console, go to <strong>Monitoring &gt; Metrics Explorer</strong>.</li>
<li>In the "Metric" selector, search for "API Gateway" metrics. Key metrics to monitor include:<ul>
<li><strong><code>gateway/request_count</code></strong>: Total number of requests received.</li>
<li><strong><code>gateway/error_count</code></strong>: Number of requests resulting in errors.</li>
<li><strong><code>gateway/request_latencies</code></strong>: Distribution of request latencies (useful for P50, P90, P99 analysis).</li>
<li><strong><code>gateway/consumed_bytes_count</code> / <code>gateway/produced_bytes_count</code></strong>: Data transfer.</li>
</ul>
</li>
<li>You can create <strong>custom dashboards</strong> to visualize these metrics tailored to your needs.</li>
<li>Set up <strong>alerts</strong> based on thresholds (e.g., alert if error rate exceeds X% or latency goes above Y ms) to be proactively notified of potential issues.</li>
</ul>
</li>
</ol>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../diagram-examples/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Diagram Examples">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Diagram Examples
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Karrera.AI
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.google.com" target="_blank" rel="noopener" title="www.google.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.google.com" target="_blank" rel="noopener" title="www.google.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.498 6.186a3.02 3.02 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.02 3.02 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.02 3.02 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.02 3.02 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814M9.545 15.568V8.432L15.818 12z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>